<div class="space-y-6">
  <div>
    <h1 class="text-2xl font-bold text-white">Exception Requests</h1>
    <p class="text-neutral-400 mt-1">Review and manage student exception requests</p>
  </div>

  <div class="flex gap-2">
    <button (click)="setFilter('pending')"
            [class]="'px-4 py-2 rounded-lg text-sm font-medium transition-colors ' + 
                     (activeFilter === 'pending' ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700')">
      Pending ({{ pendingCount }})
    </button>
    <button (click)="setFilter('approved')"
            [class]="'px-4 py-2 rounded-lg text-sm font-medium transition-colors ' + 
                     (activeFilter === 'approved' ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700')">
      Approved
    </button>
    <button (click)="setFilter('rejected')"
            [class]="'px-4 py-2 rounded-lg text-sm font-medium transition-colors ' + 
                     (activeFilter === 'rejected' ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700')">
      Rejected
    </button>
    <button (click)="setFilter('all')"
            [class]="'px-4 py-2 rounded-lg text-sm font-medium transition-colors ' + 
                     (activeFilter === 'all' ? 'bg-indigo-500/20 text-indigo-400 border border-indigo-500/30' : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700')">
      All
    </button>
  </div>

  @if (loading) {
    <div class="flex justify-center py-12">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
    </div>
  } @else if (filteredRequests.length === 0) {
    <div class="bg-neutral-800 rounded-xl p-12 text-center border border-neutral-700">
      <p class="text-neutral-400">No {{ activeFilter === 'all' ? '' : activeFilter }} requests found</p>
    </div>
  } @else {
    <div class="bg-neutral-800 rounded-xl border border-neutral-700 overflow-hidden">
      <table class="w-full">
        <thead class="bg-neutral-900">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-medium text-neutral-400 uppercase">Student</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-neutral-400 uppercase">Type</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-neutral-400 uppercase">Status</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-neutral-400 uppercase">Date</th>
            <th class="px-6 py-4 text-right text-xs font-medium text-neutral-400 uppercase">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-neutral-700">
          @for (request of filteredRequests; track request.id) {
            <tr class="hover:bg-neutral-700/50">
              <td class="px-6 py-4">
                <div class="text-white font-medium">{{ request.student?.user?.username }}</div>
                <div class="text-sm text-neutral-400">{{ request.student?.code }}</div>
              </td>
              <td class="px-6 py-4 text-neutral-300">
                {{ exceptionTypes[request.type] || request.type }}
              </td>
              <td class="px-6 py-4">
                <span [class]="'px-2 py-1 rounded text-xs font-medium ' + getStatusClass(request.status)">
                  {{ request.status | titlecase }}
                </span>
              </td>
              <td class="px-6 py-4 text-neutral-400 text-sm">
                {{ request.created_at | date:'short' }}
              </td>
              <td class="px-6 py-4 text-right">
                @if (request.status === 'pending') {
                  <button (click)="openAction(request)"
                          class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded transition-colors">
                    Review
                  </button>
                } @else {
                  <button (click)="openAction(request)"
                          class="px-3 py-1 bg-neutral-700 hover:bg-neutral-600 text-neutral-300 text-sm rounded transition-colors">
                    View
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

@if (selectedRequest) {
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-neutral-800 rounded-xl w-full max-w-lg border border-neutral-700">
      <div class="p-6 border-b border-neutral-700">
        <h2 class="text-lg font-semibold text-white">Exception Request Details</h2>
      </div>

      <div class="p-6 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-neutral-400">Student</p>
            <p class="text-white">{{ selectedRequest.student?.user?.username }}</p>
            <p class="text-sm text-neutral-400">{{ selectedRequest.student?.code }}</p>
          </div>
          <div>
            <p class="text-xs text-neutral-400">Type</p>
            <p class="text-white">{{ exceptionTypes[selectedRequest.type] }}</p>
          </div>
        </div>

        <div>
          <p class="text-xs text-neutral-400 mb-1">Reason</p>
          <p class="text-neutral-300 bg-neutral-900 p-3 rounded-lg">{{ selectedRequest.reason }}</p>
        </div>

        @if (selectedRequest.status === 'pending') {
          <div>
            <label class="block text-xs text-neutral-400 mb-1">
              Admin Notes {{ selectedRequest.status === 'pending' ? '(required for rejection)' : '' }}
            </label>
            <textarea [(ngModel)]="adminNotes" rows="3"
                      placeholder="Add notes about your decision..."
                      class="w-full px-4 py-3 bg-neutral-900 border border-neutral-600 rounded-lg text-white placeholder-neutral-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></textarea>
          </div>

          @if (actionError) {
            <div class="p-3 bg-red-500/20 border border-red-500/30 rounded-lg text-red-400 text-sm">
              {{ actionError }}
            </div>
          }
        } @else if (selectedRequest.admin_notes) {
          <div>
            <p class="text-xs text-neutral-400 mb-1">Admin Notes</p>
            <p class="text-neutral-300 bg-neutral-900 p-3 rounded-lg">{{ selectedRequest.admin_notes }}</p>
            <p class="text-xs text-neutral-500 mt-2">
              Reviewed by {{ selectedRequest.reviewer?.username }} on {{ selectedRequest.reviewed_at | date:'medium' }}
            </p>
          </div>
        }
      </div>

      <div class="p-6 border-t border-neutral-700 flex justify-end gap-3">
        <button (click)="closeAction()"
                class="px-4 py-2 bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg transition-colors">
          Close
        </button>
        @if (selectedRequest.status === 'pending') {
          <button (click)="reject()" [disabled]="processing"
                  class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:opacity-50 text-white rounded-lg transition-colors">
            {{ processing ? 'Processing...' : 'Reject' }}
          </button>
          <button (click)="approve()" [disabled]="processing"
                  class="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:opacity-50 text-white rounded-lg transition-colors">
            {{ processing ? 'Processing...' : 'Approve' }}
          </button>
        }
      </div>
    </div>
  </div>
}
